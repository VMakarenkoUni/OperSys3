name: Node CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        node: [18]

    defaults:
      run:
        working-directory: backend

    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}
      
      - name: Setup PostgreSQL (Ubuntu)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo systemctl start postgresql
          sudo -u postgres psql -c "ALTER USER postgres PASSWORD 'postgres';"
          sudo -u postgres psql -c "CREATE DATABASE filemanager;"
          sudo sed -i 's/port = 5432/port = 5433/' /etc/postgresql/*/main/postgresql.conf
          sudo systemctl restart postgresql
      
      - name: Setup PostgreSQL (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          brew install postgresql@15
          brew services start postgresql@15
          sleep 3
          /opt/homebrew/opt/postgresql@15/bin/psql -d postgres -c "ALTER USER $(whoami) WITH PASSWORD 'postgres';"
          /opt/homebrew/opt/postgresql@15/bin/createdb filemanager
          /opt/homebrew/opt/postgresql@15/bin/psql -d postgres -c "ALTER SYSTEM SET port = 5433;"
          brew services restart postgresql@15
          sleep 3
      
      - name: Setup PostgreSQL (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          choco install postgresql15 --params '/Password:postgres /Port:5433' -y
          Set-Service -Name postgresql-x64-15 -StartupType Automatic
          Start-Service -Name postgresql-x64-15
          Start-Sleep -Seconds 5
          & "C:\Program Files\PostgreSQL\15\bin\psql.exe" -U postgres -p 5433 -c "CREATE DATABASE filemanager;"
      
      - name: Install dependencies
        run: npm install
      
      - name: Run tests
        env:
          DB_HOST: localhost
          DB_PORT: 5433
          DB_USER: postgres
          DB_PASSWORD: postgres
          DB_NAME: filemanager
        run: npm test
      
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs-${{ matrix.os }}
          path: backend/coverage/
